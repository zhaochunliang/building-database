extends layout

block content
  section.container
    div.col-7
      h1 Add a building

      form#add-form
        label(for="name") Name:
        input#name(type="text" name="name" placeholder="Building name" required)

        label(for="model") Model:
        input#model(type="file" name="model" accept=".zip,.obj,.dae,.ply,.dxf", required)

        label(for="creator") Creator (if not created by you):
        input#creator(type="text" name="creator" placeholder="Original creator of the model")

        label(for="creator-url") Creator URL (if not created by you):
        input#creator-url(type="url" name="creator-url" placeholder="Link to the original creator")

        label(for="method") How was the model created?
        select#method(name="method" required)
          option(value="") Select a method
          option(value="handmade") Handmade
          option(value="automated") Automated
          option(value="unknown") Unknown

        label(for="description") Description:
        textarea#description(name="description" placeholder="More detail on the building and your model" maxlength="500")

        button#add-button(type="submit") Add building

  script.
    var addForm = document.getElementById("add-form");
    var nameInput = document.getElementById("name");
    var fileInput = document.getElementById("model");
    var creatorInput = document.getElementById("creator");
    var creatorURLInput = document.getElementById("creator-url");
    var methodInput = document.getElementById("method");
    var descInput = document.getElementById("description");
    var addButton = document.getElementById("add-button");

    // TODO: Catch errors and notify user
    addForm.addEventListener("submit", function(event) {
      event.target.checkValidity();
      event.preventDefault();

      addButton.innerHTML = "Uploading&hellip;";

      var files = fileInput.files;
      var file = files[0];

      // This requires IE 10+
      // What are the ramifications of this?
      // What alternatives exist for async file upload?
      var formData = new FormData();

      // Check the file type.
      if (!file.name.match(".*\.zip|.*\.obj|.*\.dae|.*\.ply|.*\.dxf")) {
        console.log("Model file type not valid");
        return;
      }

      formData.append("name", nameInput.value);
      formData.append("model", file, file.name);

      if (creatorInput.value) {
        formData.append("creator", creatorInput.value);
      }

      if (creatorURLInput.value) {
        formData.append("creatorURL", creatorURLInput.value);
      }

      formData.append("method", methodInput.value);
      
      formData.append("description", descInput.value);

      $.ajax({
        url: "/api/buildings",
        data: formData,
        processData: false,
        contentType: false,
        type: "POST",
        success: function(data, status, xhr) {
          window.location.href = "/add/location/" + data.building._id;
        },
        error: function(xhr, errorType, error) {
          // TODO: Display error and course of action

          // Unauthenticated
          if (xhr.status === 403) {
            // Redirect to login page
            window.location.href = "/login";
          }

          console.log(xhr.status);
          console.log(errorType);
          console.log(error);
        }
      });
    });