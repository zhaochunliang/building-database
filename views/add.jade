extends layout

block content
  h1 Add a building

  form
    label(for="name") Name:
    input#name(type="text", name="name")
    label(for="center-latitude") Center latitude:
    input#center-latitude(type="text", name="center-latitude")
    label(for="center-longitude") Center longitude:
    input#center-longitude(type="text", name="center-longitude")
    input#model(type="file", name="model", accept=".obj,.dae,.ply,.dxf")
    button#add-button Add building

  script.
    var nameInput = document.getElementById("name");
    var centerLatitudeInput = document.getElementById("center-latitude");
    var centerLongitudeInput = document.getElementById("center-longitude");
    var fileInput = document.getElementById("model");
    var addButton = document.getElementById("add-button");

    // TODO: Catch errors and notify user
    addButton.addEventListener("click", function(event) {
      event.preventDefault();

      addButton.innerHTML = "Uploading&hellip;";

      var files = fileInput.files;
      var file = files[0];

      // This requires IE 10+
      // What are the ramifications of this?
      // What alternatives exist for async file upload?
      var formData = new FormData();

      // Check the file type.
      if (!file.name.match(".*\.obj|.*\.dae|.*\.ply|.*\.dxf")) {
        console.log("Model file type not valid");
        return;
      }

      // Add the name to the request
      formData.append("name", nameInput.value);

      // Add the coordindates to the request
      formData.append("centerLatitude", centerLatitudeInput.value);
      formData.append("centerLongitude", centerLongitudeInput.value);

      // Add the file to the request.
      formData.append("model", file, file.name);

      $.ajax({
        url: "/api/buildings",
        data: formData,
        processData: false,
        contentType: false,
        type: "POST",
        success: function(data, status, xhr) {
          window.location.href = "/building/" + data.building._id;
        },
        error: function(xhr, errorType, error) {
          // TODO: Display error and course of action
          console.log(errorType);
          console.log(error);
        }
      });
    });