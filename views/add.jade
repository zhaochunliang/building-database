extends layout

block content
  h1 Add a building

  form#add-form
    label(for="name") Name:
    input#name(type="text", name="name", required)

    label(for="center-latitude") Location:
    iframe#add-map(src="https://cdn.rawgit.com/pelias/demo/jump-locations/index.html" frameborder="0")
    input#center-latitude(type="text", name="center-latitude" disabled)
    input#center-longitude(type="text", name="center-longitude" disabled)

    label(for="model") Model:
    input#model(type="file", name="model", accept=".obj,.dae,.ply,.dxf", required)

    button#add-button(type="submit") Add building

  script.
    var addForm = document.getElementById("add-form");
    var nameInput = document.getElementById("name");
    var centerLatitudeInput = document.getElementById("center-latitude");
    var centerLongitudeInput = document.getElementById("center-longitude");
    var fileInput = document.getElementById("model");
    var addButton = document.getElementById("add-button");

    var onHashChange = function(e) {
      var splitHash = e.data.split(",");

      centerLatitudeInput.value = splitHash[1];
      centerLongitudeInput.value = splitHash[2];
    };

    ("Microsoft Internet Explorer" == navigator.appName) ? window.attachEvent("onmessage", onHashChange) : window.addEventListener("message", onHashChange, !1);

    // TODO: Catch errors and notify user
    addForm.addEventListener("submit", function(event) {
      event.target.checkValidity();
      event.preventDefault();

      addButton.innerHTML = "Uploading&hellip;";

      var files = fileInput.files;
      var file = files[0];

      // This requires IE 10+
      // What are the ramifications of this?
      // What alternatives exist for async file upload?
      var formData = new FormData();

      // Check the file type.
      if (!file.name.match(".*\.obj|.*\.dae|.*\.ply|.*\.dxf")) {
        console.log("Model file type not valid");
        return;
      }

      // Add the name to the request
      formData.append("name", nameInput.value);

      // Add the coordindates to the request
      formData.append("centerLatitude", centerLatitudeInput.value);
      formData.append("centerLongitude", centerLongitudeInput.value);

      // Add the file to the request.
      formData.append("model", file, file.name);

      $.ajax({
        url: "/api/buildings",
        data: formData,
        processData: false,
        contentType: false,
        type: "POST",
        success: function(data, status, xhr) {
          window.location.href = "/building/" + data.building._id;
        },
        error: function(xhr, errorType, error) {
          // TODO: Display error and course of action
          console.log(errorType);
          console.log(error);
        }
      });
    });